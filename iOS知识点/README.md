 <div class="rich_media_content " id="js_content" style="visibility: visible;">
     

     

     
     
     <h1 style="box-sizing: border-box;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 28px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 17px;">前言</span></h1><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">今天要和大家分享的是 Facebook 提供的一个动态修改链接 mach-O 文件的工具 fishhook。</span><span style="font-size: 14px;">它利用 MachO 文件加载原理，通过修改懒加载和非懒加载两个表的指针达到 C 函数 HOOK 的目的。</span></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">这个工具本身代码才两百多行,如果你对 MachO 有一定的了解推荐读者阅读其源码.本文将从 fishhook 的使用切入,带着大家探索其原理。</span><span style="font-size: 14px;">废话不多说,我们上代码。</span></p><h3 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 20px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">fishhook简单使用</span></h3><h4 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 18px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">它所提供的接口</span></h4><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">拿到 fishhook 之后你会发现，它真的非常简单，这家伙只有两个文件 “fishhook.h” 和 “fishhook.c”。</span><span style="font-size: 14px;">它提供的接口仅有一个结构体和两个函数：</span></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;"><strong style="box-sizing: border-box;color: rgb(0, 0, 0);">rebinding 结构体</strong>用来确定你要 HOOK 的函数和要交换的函数地址。</span></p><pre class="" style="box-sizing: border-box;padding-top: 8px;padding-bottom: 6px;background: rgb(45, 45, 45);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);text-align: start;font-size: 10px;line-height: 12px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 1px !important;border-style: solid !important;border-color: rgb(226, 226, 226) !important;"><ol class="list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">struct</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebinding {</span></code></span></p></li><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">constchar </span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">*name;</span><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//需要HOOK的函数名称，C字符串</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">void </span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">*replacement;</span><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//新函数的地址</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">void</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> **replaced;</span><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//原始函数地址的指针！</span></code></span></p></li></ol><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">};</span></code></span></p></li></ol></pre><blockquote style="box-sizing: border-box;margin-bottom: 1.2em;padding: 15px 15px 15px 1rem;color: rgb(129, 145, 152);border-left-width: 6px;border-left-color: rgb(96, 125, 139);font-size: 14px;line-height: 22px;background: rgb(242, 247, 251);font-family: Helvetica, Arial, sans-serif;text-align: start;white-space: normal;"><p style="box-sizing: border-box;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);">注意replaced：在使用该结构体时，由于函数内部要修改外部指针变量所保存的值，所以这里是指针的指针（二级指针）。</p></blockquote><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;"><strong style="box-sizing: border-box;color: rgb(0, 0, 0);">rebind_<span style="box-sizing: border-box;font-weight: 400;"><strong style="font-family: Helvetica, Arial, sans-serif;font-size: 14px;text-align: start;white-space: pre-line;box-sizing: border-box;color: rgb(0, 0, 0);">symbols</strong></span></strong><span style="box-sizing: border-box;"> 和 <strong style="box-sizing: border-box;color: rgb(0, 0, 0);">rebind_</strong></span><strong style="box-sizing: border-box;color: rgb(0, 0, 0);">symbols_image</strong> 函数用来 HOOK 的两个方法。只不过后者是指定某个<strong style="box-sizing: border-box;color: rgb(0, 0, 0);">镜像文件</strong>的时候使用。所以一般我们直接使用前者。</span></p><blockquote style="box-sizing: border-box;margin-bottom: 1.2em;padding: 15px 15px 15px 1rem;color: rgb(129, 145, 152);border-left-width: 6px;border-left-color: rgb(96, 125, 139);font-size: 14px;line-height: 22px;background: rgb(242, 247, 251);font-family: Helvetica, Arial, sans-serif;text-align: start;white-space: normal;"><p style="box-sizing: border-box;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);">镜像文件：比如 NSLog 函数是在 Fundation 框架中，那么 Fundation 在内存中就是一个镜像文件。</p></blockquote><pre class="" style="box-sizing: border-box;padding-top: 8px;padding-bottom: 6px;background: rgb(45, 45, 45);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);text-align: start;font-size: 10px;line-height: 12px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 1px !important;border-style: solid !important;border-color: rgb(226, 226, 226) !important;"><ol class="list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">int</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebind_symbols(</span><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">struct</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebinding rebindings[], </span><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">size_t</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebindings_nel);</span></code></span></p></li><li><p><br></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">int</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebind_symbols_image(</span><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">void</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">*header,</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">intptr_t</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> slide,</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">struct</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebinding rebindings[],</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">size_t</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebindings_nel);</span></code></span></p></li></ol></pre><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">多说无益，玩一下最重要！</span></p><h4 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 18px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">HOOK一下NSLog</span></h4><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">我们新建一个 SingleView 的项目。</span><span style="font-size: 14px;">在 ViewDidLoad 中对系统的&nbsp;<strong style="box-sizing: border-box;color: rgb(0, 0, 0);">NSLog&nbsp;</strong>函数进行 HOOK 。</span></p><pre class="" style="box-sizing: border-box;padding-top: 8px;padding-bottom: 6px;background: rgb(45, 45, 45);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);text-align: start;font-size: 10px;line-height: 12px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 1px !important;border-style: solid !important;border-color: rgb(226, 226, 226) !important;"><ol class="list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//函数指针</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">staticvoid</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(*sys_nslog)(</span><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">NSString</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">* format,...);</span></code></span></p></li><li><p><br></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//定义一个新的函数。HOOK成功后NSLog调用时，会来到这里</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">void</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> myNSLog(</span><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">NSString</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">* format,...){</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">    format = [format stringByAppendingString:@</span><span class="" style="box-sizing: border-box;color: rgb(153, 204, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"\n上钩了！\n\n"</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">];</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">    sys_nslog(format);</span><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//调用系统的NSLog，HOOK成功后sys_nslog指针保存的是Fundation中NSLog的地址</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">}</span></code></span></p></li><li><p><br></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">- (</span><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">void</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)viewDidLoad {</span></code></span></p></li><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">[</span><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">super</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> viewDidLoad];</span></code></span></p></li></ol><li><p><br></p></li><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//准备rebinding结构体</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">struct</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebinding nslog;</span></code></span></p></li></ol><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">    nslog.name = </span><span class="" style="box-sizing: border-box;color: rgb(153, 204, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"NSLog"</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">;</span><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//需要HOOK的函数名称</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">    nslog.replacement = myNSLog;</span><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//新函数的地址</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">    nslog.replaced = (</span><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">void</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">*)&amp;sys_nslog;</span><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//原始函数指针</span></code></span></p></li><li><p><br></p></li><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">//准备数组，将一个或多个 rebinding 结构体放进去。</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">struct</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> rebinding rebs[</span><span class="" style="box-sizing: border-box;color: rgb(249, 145, 87);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">1</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">] = {nslog};</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">/**</span></code></span></p></li></ol><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">     arg1: 存放rebinding 结构体的数组</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">     arg2: 数组的长度</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(153, 153, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">     */</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">    rebind_symbols(rebs, </span><span class="" style="box-sizing: border-box;color: rgb(249, 145, 87);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">1</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">);</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">}</span></code></span></p></li><li><p><br></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">-(</span><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">void</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)touchesBegan:(</span><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">NSSet</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">&lt;</span><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">UITouch</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">*&gt; *)touches withEvent:(</span><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">UIEvent</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">*)</span><span class="" style="box-sizing: border-box;color: rgb(204, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">event</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">{</span></code></span></p></li><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(102, 153, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">NSLog</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(@</span><span class="" style="box-sizing: border-box;color: rgb(153, 204, 153);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"点击了屏幕！"</span><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">);</span></code></span></p></li></ol><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;overflow-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="" style="box-sizing: border-box;color: rgb(204, 204, 204);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">}</span></code></span></p></li></ol></pre><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">运行之后，可以发现 NSLog 的函数调用已经被 HOOK 成功了！</span><span style="font-size: 14px;">几行代码轻松搞定，看起来很厉害的样子。</span><span style="font-size: 14px;">（PS：</span><span style="font-size: 14px;">但是剧情如果这样发展，太过简单了。</span><span style="font-size: 14px;">我预感，马上会有一个转折...）接下来迫不及待的，我们 HOOK 一下自定义的函数，结果你会发现怎么都 HOOK 不到。</span><span style="font-size: 14px;">姿势和 HOOK 系统的 NSLog 一样（代码我就不贴了，不信你自己去 <span style="text-decoration: line-through;">浪费时间</span>&nbsp;尝试）。</span><span style="font-size: 14px;">那为什么系统函数能 HOOK 成功，自定义的却 HOOK 不到呢？</span><span style="font-size: 14px;">so~，往下看...</span></p><h3 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 20px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">fishHook原理分析</span></h3><h4 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 18px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">MachO</span></h4><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">首先我们要了解一个东西。</span><span style="font-size: 14px;">我们写好的代码，生成的 iOS 程序其实是一个可执行文件。</span><span style="font-size: 14px;">这个文件格式是 MachO 格式，所以一般我们称其为&nbsp;<strong style="box-sizing: border-box;color: rgb(0, 0, 0);">MachO&nbsp;</strong>文件。</span><span style="font-size: 14px;">在刚才的 APP 包里面，它长这样：</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.5304182509505704" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOdY4N0xK9VaueAfNbEpDyMicuEc3VCTsb0hEV0mju9QDdzicLJGhx3fpQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="526" style="width: 526px !important; height: 279.939px !important;" _width="526px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">这个文件里面包含的就是数据和指令。</span><span style="font-size: 14px;">比如你定义的类、方法、全局变量、方法实现等等。</span><span style="font-size: 14px;">我们为什么要讨论 MachO？</span><span style="font-size: 14px;">因为结合上面的疑问我们思考一个问题：</span><span style="font-size: 14px;"><strong style="box-sizing: border-box;color: rgb(0, 0, 0);">自定义函数和系统函数，在文件位置上有什么区别？</strong><strong style="box-sizing: border-box;color: rgb(0, 0, 0);"></strong></span></p><ul style="list-style-type: square;" class="list-paddingleft-2"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);line-height: 22px;font-size: 14px;"><strong style="box-sizing: border-box;color: rgb(0, 0, 0);">自定义函数</strong>在本 MachO 文件中，在运行时刻进入内存，自定义函数在本镜像文件中。</span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);line-height: 22px;font-size: 14px;"><strong style="box-sizing: border-box;color: rgb(0, 0, 0);">系统函数</strong>在系统框架中，在运行时刻进入内存，系统函数在系统的动态库中，比如 NSLog 在 Fundation 这个镜像文件中。</span></p></li></ul><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">那既然如此我们就可以得到这样的结论：</span><span style="font-size: 14px;">自定义的函数，在编译时刻，编译器就可以确定函数的实现地址（在 MachO 文件中的偏移地址）。</span><span style="font-size: 14px;">但是系统函数是没办法知道的。</span><span style="font-size: 14px;">那么在 CPU 执行我们的代码的时候，我们是如何告诉 CPU ，我们需要调用系统函数。</span><span style="font-size: 14px;">以及如何知道系统函数的地址的呢？</span><span style="font-size: 14px;">这里就要提到 PIC 技术了。</span></p><h4 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 18px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">PIC（Position Independ code）技术</span></h4><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">PIC翻译过来就是位置独立代码。</span></p><blockquote style="box-sizing: border-box;margin-bottom: 1.2em;padding: 15px 15px 15px 1rem;color: rgb(129, 145, 152);border-left-width: 6px;border-left-color: rgb(96, 125, 139);font-size: 14px;line-height: 22px;background: rgb(242, 247, 251);font-family: Helvetica, Arial, sans-serif;text-align: start;white-space: normal;"><p style="box-sizing: border-box;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);">说人话：比如当你的程序要调用一个 MachO 外部函数的时候，编译器是没办法知道该函数的地址的。所以它在 MachO 文件里面生成一个列表，列表里面放指针。让当前的系统函数调用指向这个列表里面对应的指针。等到我们的 MachO 文件加载进入内存时，再将系统函数的真实地址，一个一个的赋值给列表中的指针。</p></blockquote><ul style="list-style-type: square;" class="list-paddingleft-2"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);line-height: 22px;font-size: 14px !important;">那么这个列表，我们称为<strong style="box-sizing: border-box;color: rgb(0, 0, 0);">符号表</strong>。</span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);line-height: 22px;font-size: 14px !important;">这里面的指针，我们称为<strong style="box-sizing: border-box;color: rgb(0, 0, 0);">符号</strong>。</span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);line-height: 22px;font-size: 14px !important;">给里面的指针赋值的过程，我们称为<strong style="box-sizing: border-box;color: rgb(0, 0, 0);">符号绑定</strong>。</span></p></li></ul><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">那么说到这里，我想很多童鞋已经猜到了。</span><span style="font-size: 14px;">fishhook 之所以 HOOK 不了自定义的函数，就是因为自定义的函数没有通过符号寻找地址这个过程。</span><span style="font-size: 14px;">而系统函数是通过符号去绑定实现地址的。</span><span style="font-size: 14px;">fishhook 就是利用这一点，去修改了系统函数的符号达到 HOOK 的目的。</span><span style="font-size: 14px;">其实我们通过fishhook 的函数名称就不难看出来&nbsp;<strong style="box-sizing: border-box;color: rgb(0, 0, 0);">rebind_symbols&nbsp;</strong>符号重绑定。</span></p><blockquote style="box-sizing: border-box;margin-bottom: 1.2em;padding: 15px 15px 15px 1rem;color: rgb(129, 145, 152);border-left-width: 6px;border-left-color: rgb(96, 125, 139);font-size: 14px;line-height: 22px;background: rgb(242, 247, 251);font-family: Helvetica, Arial, sans-serif;text-align: start;white-space: normal;"><p style="box-sizing: border-box;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);">这篇文章到这里其实已经差不多了。不过理论总归是理论，很多人总想眼见为实的探索。如果你想探索，那么你准备酒，我准备&nbsp;<span style="text-decoration: line-through;">肉</span>&nbsp;MachOView，我们往下走...</p></blockquote><h3 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 20px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">fishHook原理探索</span></h3><h4 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 18px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">观察符号绑定和重绑定过程</span></h4><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">MachO 文件内部存有代码和数据，代码放在 _TEXT 段（代码段）中，数据放在 _DATA 段（数据段）中。</span><span style="font-size: 14px;">数据段除了全局变量、常量、自定义类还有很多东西，比如我们刚才提到的<strong style="box-sizing: border-box;color: rgb(0, 0, 0);">符号表</strong>。</span><span style="color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;white-space: pre-line;background-color: rgb(255, 255, 255);font-size: 14px;">接下来，我们要借助一个图形化工具，去分析我们的 MachO 文件。这个工具就是&nbsp;</span><span style="font-size: 14px;">MachOView ，它长这样：</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.9243697478991597" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOEzfEJyKYO81YM03RqmLb98aSvAnBOiaqKoOcsffRIpia9TrPtQBRFGMw/640?wx_fmt=jpeg" data-type="jpeg" data-w="119" style="width: 119px !important; height: 110.151px !important;" _width="119px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><h5 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;">分析MachO文件</h5><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">我们将刚才的 MachO 文件放入到 MachOView 里面分析一下。</span><span style="font-size: 14px;">可以看到下图</span>。</p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.7384769539078156" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOJe6Cy3cur3vUzLohJKX71ziaxT4FXpaibCqmal9X6OnRk0IWRQx4tYzA/640?wx_fmt=jpeg" data-type="jpeg" data-w="998" style="width: 677px !important; height: 500.472px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><h5 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;">找到符号偏移地址</h5><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">在这里面我们就可以清晰的看到符号表在文件中长啥样了。</span><span style="font-size: 14px;">并且最重要的是能够看出符号在文件中的偏移位置。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.0806697108066971" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOljYVNYDmQXAv23DPygKZ8mVJCsXeoyBHbJKBVZ61hLXdiaM1krUm4QA/640?wx_fmt=jpeg" data-type="jpeg" data-w="657" style="width: 657px !important; height: 54.8387px !important;" _width="657px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p><span style="font-size: 14px;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">有了这个偏移值，我们可以在项目运行的时候，通过LLDB，观察的符号的绑定和重绑定过程。</span></p><p><br></p><h5 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;">动态调试</h5><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">1、来到我们原来的代码，在这几行打上断点并运行。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.4919786096256685" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tO5hLe5IkZaJhCCjQr0ia7A4JvGx5Iyc7kIJbu59FSLGE9RSO7M6Jf0Yg/640?wx_fmt=jpeg" data-type="jpeg" data-w="561" style="width: 561px !important; height: 277.016px !important;" _width="561px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">2、第一次断点触发时,我们利用 <strong style="box-sizing: border-box;color: rgb(0, 0, 0);">LLDB</strong> 查看符号中的值。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.10905730129390019" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOheiak0FRhOyK83RrlUEOrabGnpeyeVNjGLiaUytWu3mAQOdicG3aeTK6w/640?wx_fmt=jpeg" data-type="jpeg" data-w="541" style="width: 541px !important; height: 60.7819px !important;" _width="541px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">首先查看 MachO 文件的地址：</span><span style="font-size: 14px;">通过 </span><code class="" style="box-sizing: border-box;background: rgb(243, 241, 241);color: rgb(88, 88, 88);line-height: 18px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span style="box-sizing: border-box;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;display: inline-block;padding-right: 2px;padding-left: 2px;font-size: 14px;">image list</span></code><span style="font-size: 14px;">指令，查看所有镜像文件（ MachO 文件）的地址。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.24452133794694347" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOSXmhdwS1HmgVKPDOGuxNrb26LCePicBKuu1zkF7uZM0Ajd3aHRibia18w/640?wx_fmt=jpeg" data-type="jpeg" data-w="867" style="width: 677px !important; height: 167.052px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">然后通过 </span><code class="" style="box-sizing: border-box;background: rgb(243, 241, 241);color: rgb(88, 88, 88);line-height: 18px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span style="box-sizing: border-box;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;display: inline-block;padding-right: 2px;padding-left: 2px;font-size: 14px;">memory read</span></code><span style="font-size: 14px;">指令读取内存。</span><span style="font-size: 14px;">因为符号是指针，所以读取8个字节的数据。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.1543942992874109" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOxrOicer6sZp2aicKO0sYic3Mcl5tv8A4FDgd6l7HfnicucSpgsJ8UDWoCw/640?wx_fmt=jpeg" data-type="jpeg" data-w="421" style="width: 421px !important; height: 66.6912px !important;" _width="421px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">但是这里面存放的到底是不是 NSLog 的真实地址呢？</span><span style="font-size: 14px;">我们如何查看</span>。</p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">我们可以利用 </span><code class="" style="box-sizing: border-box;background: rgb(243, 241, 241);color: rgb(88, 88, 88);line-height: 18px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span style="box-sizing: border-box;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;display: inline-block;padding-right: 2px;padding-left: 2px;font-size: 14px;">dis-s</span></code><span style="font-size: 14px;">查看反汇编。</span><span style="font-size: 14px;">由于 iOS 的小端模式，所以读数据从右往左读。</span><span style="font-size: 14px;">比如：</span><span style="font-size: 14px;">图中数据 </span><code class="" style="box-sizing: border-box;background: rgb(243, 241, 241);color: rgb(88, 88, 88);line-height: 18px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span style="box-sizing: border-box;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;display: inline-block;padding-right: 2px;padding-left: 2px;font-size: 14px;">d0 ea e10201000000</span></code><span style="font-size: 14px;">那么读取出来的地址是 </span><code class="" style="box-sizing: border-box;background: rgb(243, 241, 241);color: rgb(88, 88, 88);line-height: 18px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span style="box-sizing: border-box;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;display: inline-block;padding-right: 2px;padding-left: 2px;font-size: 14px;">0x0102e1ead0</span></code><code class="" style="box-sizing: border-box;background: rgb(243, 241, 241);color: rgb(88, 88, 88);line-height: 18px;font-family: consolas, menlo, courier, monospace, &quot;Microsoft Yahei&quot;!important;border-width: 0px !important;border-style: initial !important;border-color: initial !important;"><span class="" style="box-sizing: border-box;background-image: initial;background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;display: inline-block;padding-right: 2px;padding-left: 2px;font-size: 14px;"></span></code></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.48863636363636365" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tO10rwJFyHSJfjyPL3hWuaVbLyyJVHIdY1BBVmX9T0zZ4Yrc7YIuicexg/640?wx_fmt=jpeg" data-type="jpeg" data-w="352" style="width: 352px !important; height: 173.023px !important;" _width="352px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">然后我们通过汇编发现，这里并不是 NSLog 的地址。</span><span style="font-size: 14px;">如果是，这里会显示 Fundation 框架中的 NSLog 函数（等下会看到现象）。</span><span style="font-size: 14px;">其原因是因为 NSLog 是懒加载符号，此时是第一次调用，还没有绑定符号。</span><span style="font-size: 14px;">此时如果跟汇编，我们最终会看到 dyld_stub_binder 函数的调用。</span><span style="font-size: 14px;">所以，我们过掉断点。</span></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">3、来到第二个断点处</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.20794392523364486" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOic1X2XcPOOocm9ia6DRzzibd7qb5ga6aibKHtgYYGVWwl518mMDia5Mj7IA/640?wx_fmt=jpeg" data-type="jpeg" data-w="428" style="width: 428px !important; height: 90.5841px !important;" _width="428px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">我们重复上面的步骤，查看符号的内存数据，然后取出里面的值，通过 dis 反汇编查看。</span><span style="font-size: 14px;">你会发现此刻已经绑定了符号。</span><span style="font-size: 14px;">可以清晰的看到里面是 NSLog 的实现地址了。</span><span style="font-size: 14px;">（这个过程就是符号绑定！</span><span style="font-size: 14px;">）</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.4267515923566879" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOK0WyVdzz10NHibaBibKyjPFpXZLftwp9b3zaxPMwjc2aKsOot4K6UIgg/640?wx_fmt=jpeg" data-type="jpeg" data-w="471" style="width: 471px !important; height: 202.146px !important;" _width="471px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">接下来，我们来看看 rebind_symbols 之后，我们的符号表里面保存的地址变成了啥？</span></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">4、来到第三个断点处（第42行）</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.16273584905660377" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOAT4OfGQxTSdDdOibv3bhiaZyfAxmxyhln0FaKgcarKkibJkQKf1QPZtgQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="424" style="width: 424px !important; height: 70.6745px !important;" _width="424px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">我们重复上面的步骤，查看符号的内存数据，然后取出里面的值，通过 dis 反汇编查看。</span><span style="font-size: 14px;">你会发现此刻符号内的数据已经替换成了自定义的函数地址了。</span><span style="font-size: 14px;">（符号重绑定成功！</span><span style="font-size: 14px;">）</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.4133949191685912" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOzmTpWMVSRZ8CM352cBGpQO1Z5TqPiaAHC6slI9LYKIFBn3ibsJdewfYg/640?wx_fmt=jpeg" data-type="jpeg" data-w="433" style="width: 433px !important; height: 180.173px !important;" _width="433px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">经过一系列动态调试，我们可以观察到符号绑定和重绑定的全部过程。</span><span style="font-size: 14px;">但是，fishhook 是怎么通过我们传给它的一个字符就找到了我们 NSLog 的符号的呢？</span><span style="font-size: 14px;">我们往下看...</span></p><h4 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 18px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">通过符号找到字符串</span></h4><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">我们还是来到 MachOView 里面，注意，我们数一下，NSLog 这个符号，在懒加载符号表里面是第几个？</span><span style="font-size: 14px;">很明显第一个。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.7384769539078156" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOnJ2dPNDic8xgU0WAPa1Nw2wQ6oAnf8U6n3cwp8RibyTT2ymMmZC3G3ag/640?wx_fmt=jpeg" data-type="jpeg" data-w="998" style="width: 677px !important; height: 500.472px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">所以，与懒加载表对应的另外一张表就出来了。</span><span style="font-size: 14px;">indirect Symbols。</span><span style="font-size: 14px;">懒加载表里面 NSLog 是第一个，那么它在 indirect Symbols 表里面也就是第一个。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.7384769539078156" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOhBmaBA9eHv8vuUHNXwGw3uYunZfwORMme85KeqAXozOrx1YT2d9GYQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="998" style="width: 677px !important; height: 500.472px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">接下来，将 indirect Symbols 里面对应的 Data 值换算成为10进制。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.12244897959183673" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOvNnp1DyCUqEHUVqqMpr0t0aR5qPye1eOu9MOqvcibWQJ8hibdk8ydpFQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="686" style="width: 677px !important; height: 84.6531px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">0x81 的十进制是 129 .为什么要转换这个数据，因为它又是另外一个列表的角标。</span></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">这个列表就是 Symbols ，我们查看一下。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.7384769539078156" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOopN72v4t9wTzJwx2ib4n8ibuEUVcDEdemedFDu1f9Qz4ez11Q4CBjsrw/640?wx_fmt=jpeg" data-type="jpeg" data-w="998" style="width: 677px !important; height: 500.472px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">那么到了 Symbols 里面就接近我们最终的字符常量了。</span><span style="font-size: 14px;">注意在 Symbols 里面有 String Table 的 Index 值。</span><span style="font-size: 14px;">这里是 0xC9。</span><span style="font-size: 14px;">这就说明，在 String Table 里面，偏移 0xC9 的地址就是我们NSLog字符。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.30656934306569344" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOcxzwgeS4oIdnnRfg2XGrpjN2lkzZ0SjMHjdrEG9ib2pfVBsW7c4zFOw/640?wx_fmt=jpeg" data-type="jpeg" data-w="685" style="width: 677px !important; height: 208.934px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">我们来到 String Table 里面查看一下。</span><span style="font-size: 14px;">我们通过起始位置加上偏移便可以定位到 NSLog 字符了。</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="0.7384769539078156" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOSDvfTnFXKuWhlGvJgjwfX7dic7t2nypnu7a7VkvYfaP1rTOJOuPabyg/640?wx_fmt=jpeg" data-type="jpeg" data-w="998" style="width: 677px !important; height: 500.472px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">函数名称在字符表里面都是5F也就是 _ 开始 然后00也就是 . 结束!这也就是为什么你给 fishhook 一个系统函数名称，它能够帮你顺利 HOOK 到系统函数的原理了。</span><span style="font-size: 14px;">通过上面一顿分析，我相信官方的图你也能看懂了。</span><span style="font-size: 14px;">官方是以 close 函数为例：</span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="1.1951476793248945" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOxljLnJJOj8vmRXyDthTw5dGKVT4gldYCtUz5g2BurebYLUw7PFxceQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="948" style="width: 677px !important; height: 808.725px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><h3 style="box-sizing: border-box;margin-top: 2rem;margin-bottom: 0.5rem;font-weight: 700;color: rgb(248, 95, 72);line-height: 1.35;font-size: 20px;text-align: start;white-space: normal;font-family: Menlo, Monaco, &quot;Source Code Pro&quot;, Consolas, Inconsolata, &quot;Ubuntu Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Courier New&quot;, &quot;Droid Sans Mono&quot;, &quot;Hiragino Sans GB&quot;, 微软雅黑, monospace !important;"><span style="font-size: 16px;">后记</span></h3><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">刚才我们通过动态调试加 MachOView 的分析梳理了整个符号绑定以及重绑定的过程。</span><span style="font-size: 14px;">这个过程也是 fishhook 能够 HOOK 系统函数的原理。</span><span style="font-size: 14px;">了解了其原理接下来你可以分析一下它的源码了。</span><span style="font-size: 14px;">Facebook那帮家伙是怎么通过代码实现刚才的过程？</span><span style="font-size: 14px;">好在 fishhook 的源码并不多，但是如果你不了解 MachO 的相关 API ，这百来行代码也会让你怀疑人生。</span></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: start;"><span style="font-size: 14px;">还有一个问题，fishhook 这个工具我们可以用它来干啥？</span><span style="font-size: 14px;">我例举个实际的运用场景：</span><span style="font-size: 14px;">比如最近抖音团队分享的二进制重排启动优化。</span><span style="font-size: 14px;">在这个优化的过程中，我们如何定位到启动时所有的OC 方法？</span><span style="font-size: 14px;">我想你已经猜到了，通过 objc_msgSend 函数的 HOOK 。</span></p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: center;">有关 fishHook&nbsp;,在 <strong>12 月 17 日</strong>有一场专题分享，</p><p style="box-sizing: border-box;margin-top: 15px;margin-bottom: 15px;font-size: 16px;white-space: pre-line;line-height: 30px;color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;text-align: center;"><span style="color: rgb(74, 74, 74);font-family: Helvetica, Arial, sans-serif;font-size: 16px;text-align: start;white-space: pre-line;">扫描下方二维码立即参与！</span><br></p><p class="" style="text-align: center;"><span style="font-size: 16px;">同时可以领取 fishHook 相关<strong>学习资料及最新面试资料</strong>！</span></p><p class=""><br></p><p class="" style="text-align: center;"><span style="font-size: 16px;">赶紧扫描下方二维码一起学习吧！</span></p><p class="" style="text-align: center;"><span style="font-size: 16px;"><br></span></p><p style="text-align: center;"><img class="rich_pages img_loading" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/yoM0qNN7RwYOHKkIp9ibnGsMWjyJGl2tOwU8RGs9nanPiaZdcMXQtF0AdicZtRgjFUWBG7pv8uCwrV3fBtLdpfiaRg/640?wx_fmt=png" data-type="png" data-w="300" style="width: 300px !important; height: 300px !important;" _width="300px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous"></p><p class="" style="text-align: center;"><span style="font-size: 16px;"></span><br></p><p><br></p><p><br></p>
 </div> 
